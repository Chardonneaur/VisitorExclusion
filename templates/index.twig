{% extends 'admin.twig' %}

{% block content %}

<style>
/* ── Materialize: keep native radio + checkbox visible ───────── */
.visitorExclusion-wrap input[type="radio"],
.visitorExclusion-wrap input[type="checkbox"]:not(.ve-toggle-input) {
    opacity: 1;
    position: static;
    pointer-events: auto;
}

/* ── Toggle switch ───────────────────────────────────────────── */
.ve-switch {
    position: relative;
    display: inline-block;
    width: 34px;
    height: 18px;
    cursor: pointer;
    vertical-align: middle;
}
.ve-toggle-input {
    opacity: 0 !important;
    width: 0;
    height: 0;
    position: absolute;
}
.ve-slider {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #bdbdbd;
    border-radius: 18px;
    transition: .25s;
}
.ve-slider:before {
    position: absolute;
    content: "";
    height: 12px;
    width: 12px;
    left: 3px;
    bottom: 3px;
    background-color: #fff;
    border-radius: 50%;
    transition: .25s;
}
.ve-toggle-input:checked + .ve-slider { background-color: #43a047; }
.ve-toggle-input:checked + .ve-slider:before { transform: translateX(16px); }

/* ── Conditions summary in table ─────────────────────────────── */
.ve-cond-summary { font-size: 12px; line-height: 1.7; }
.ve-cond-item { display: block; }

/* ── Condition builder rows ──────────────────────────────────── */
.ve-condition-group { margin-bottom: 8px; }

.ve-condition-row {
    display: flex;
    gap: 6px;
    align-items: center;
}
.ve-condition-row select { flex: 1; min-width: 0; }
.ve-condition-row input[type="text"] { flex: 1.2; min-width: 0; }
.ve-condition-row .ve-remove-btn {
    flex: 0 0 auto;
    padding: 0 6px;
    height: 32px;
    line-height: 32px;
    color: #757575;
    background: transparent;
    border: none;
    cursor: pointer;
    border-radius: 2px;
}
.ve-condition-row .ve-remove-btn:hover { color: #c62828; }

.ve-row-hint {
    font-size: 11px;
    color: #757575;
    margin-top: 2px;
    padding-left: 2px;
    line-height: 1.5;
    display: none;
}
.ve-row-hint .ve-examples { font-family: monospace; }

/* ── Form section spacing ────────────────────────────────────── */
.ve-field-group { margin-bottom: 16px; }
.ve-field-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 4px;
    font-size: 13px;
    color: #444;
}
.ve-field-group input[type="text"] { width: 100%; box-sizing: border-box; }
.ve-field-group .ve-radio-group label {
    font-weight: normal;
    display: inline;
    margin-right: 24px;
    cursor: pointer;
}
</style>

<div class="visitorExclusion-wrap">

{# ══════════════════════════════════════════════════════════════
   Rules table card
════════════════════════════════════════════════════════════════ #}
<div class="card">
    <div class="card-content">
        <h2 class="card-title">{{ 'VisitorExclusion_PageTitle'|translate }}</h2>
        <p>{{ 'VisitorExclusion_PageDescription'|translate }}</p>
        <p style="color: #e65100; font-size: 12px;">
            ⚠ {{ 'VisitorExclusion_Warning'|translate }}
        </p>

        {# ── Hidden toggle forms (one per rule) ── #}
        {% for rule in rules %}
        <form method="post" id="ve-toggle-form-{{ rule.id }}" style="display:none;">
            <input type="hidden" name="nonce"   value="{{ nonce }}" />
            <input type="hidden" name="action"  value="toggle" />
            <input type="hidden" name="id"      value="{{ rule.id }}" />
            <input type="hidden" name="enabled" class="ve-enabled-input" value="" />
        </form>
        {% endfor %}

        {% if rules is empty %}
            <p class="alert alert-info">{{ 'VisitorExclusion_NoRules'|translate }}</p>
        {% else %}
        <table class="entityTable" style="width: 100%;">
            <thead>
            <tr>
                <th>{{ 'VisitorExclusion_ColumnName'|translate }}</th>
                <th>{{ 'VisitorExclusion_ColumnConditions'|translate }}</th>
                <th style="width: 55px; text-align: center;">{{ 'VisitorExclusion_ColumnMatchMode'|translate }}</th>
                <th style="width: 60px; text-align: center;">{{ 'VisitorExclusion_ColumnStatus'|translate }}</th>
                <th style="width: 70px; text-align: center;">{{ 'General_Actions'|translate }}</th>
            </tr>
            </thead>
            <tbody>
            {% for rule in rules %}
            <tr>
                <td>
                    <strong>{{ rule.name|e }}</strong>
                    {% if rule.description %}
                        <br><small style="color: #757575;">{{ rule.description|e }}</small>
                    {% endif %}
                </td>
                <td>
                    <div class="ve-cond-summary">
                        {% for cond in rule.conditions_decoded %}
                        <span class="ve-cond-item">
                            <strong>{{ availableFields[cond.field] ?? cond.field }}</strong>
                            {{ availableOperators[cond.operator] ?? cond.operator }}
                            <em>{{ cond.value|e }}</em>
                        </span>
                        {% endfor %}
                    </div>
                </td>
                <td style="text-align: center;">
                    <span title="{{ rule.match_all ? 'VisitorExclusion_MatchAll'|translate : 'VisitorExclusion_MatchAny'|translate }}"
                          style="font-size: 11px; font-weight: bold; color: #555;">
                        {{ rule.match_all ? 'VisitorExclusion_MatchModeAnd'|translate : 'VisitorExclusion_MatchModeOr'|translate }}
                    </span>
                </td>
                <td style="text-align: center;">
                    <label class="ve-switch"
                           title="{{ rule.enabled ? 'VisitorExclusion_Disable'|translate : 'VisitorExclusion_Enable'|translate }}">
                        <input type="checkbox"
                               class="ve-toggle-input ve-toggle-cb"
                               {% if rule.enabled %}checked{% endif %}
                               data-rule-id="{{ rule.id }}"
                               data-current="{{ rule.enabled ? 1 : 0 }}" />
                        <span class="ve-slider"></span>
                    </label>
                </td>
                <td style="text-align: center; white-space: nowrap;">
                    <a href="?module=VisitorExclusion&action=index&editId={{ rule.id }}"
                       class="table-action"
                       title="{{ 'General_Edit'|translate }}">
                        <span class="icon-edit"></span>
                    </a>
                    <a href="#"
                       class="table-action ve-action-delete"
                       data-rule-id="{{ rule.id }}"
                       title="{{ 'VisitorExclusion_Delete'|translate }}"
                       style="color: #c62828;">
                        <span class="icon-delete"></span>
                    </a>
                    {# Hidden delete form #}
                    <form method="post" id="ve-delete-form-{{ rule.id }}" style="display:none;">
                        <input type="hidden" name="nonce"  value="{{ nonce }}" />
                        <input type="hidden" name="action" value="delete" />
                        <input type="hidden" name="id"     value="{{ rule.id }}" />
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% endif %}

        <div class="tableActionBar">
            <a href="#ve-form-card">
                <span class="icon-add"></span>
                {{ 'VisitorExclusion_AddRule'|translate }}
            </a>
        </div>
    </div>
</div>

{# ══════════════════════════════════════════════════════════════
   Add / Edit form card
════════════════════════════════════════════════════════════════ #}
<div class="card" id="ve-form-card">
    <div class="card-content">
        <h2 class="card-title">
            {{ editRule ? 'VisitorExclusion_EditRule'|translate : 'VisitorExclusion_AddRule'|translate }}
        </h2>

        <form method="post" id="ve-rule-form">
            <input type="hidden" name="nonce"  value="{{ nonce }}" />
            <input type="hidden" name="action" value="{{ editRule ? 'update' : 'add' }}" />
            {% if editRule %}
                <input type="hidden" name="id" value="{{ editRule.id }}" />
            {% endif %}

            {# Name + Description ─────────────────────────────── #}
            <div class="row" style="margin-bottom: 0;">
                <div class="col s12 m6">
                    <div class="ve-field-group">
                        <label for="ve-name">{{ 'VisitorExclusion_RuleName'|translate }} *</label>
                        <input type="text" id="ve-name" name="name"
                               class="browser-default" required
                               value="{{ editRule ? editRule.name|e : '' }}" />
                    </div>
                </div>
                <div class="col s12 m6">
                    <div class="ve-field-group">
                        <label for="ve-description">{{ 'VisitorExclusion_RuleDescription'|translate }}</label>
                        <input type="text" id="ve-description" name="description"
                               class="browser-default"
                               value="{{ editRule ? editRule.description|e : '' }}" />
                    </div>
                </div>
            </div>

            {# Match mode ─────────────────────────────────────── #}
            <div class="ve-field-group">
                <label>{{ 'VisitorExclusion_MatchMode'|translate }}</label>
                <div class="ve-radio-group">
                    <label>
                        <input type="radio" name="match_all" value="1"
                               {% if not editRule or editRule.match_all %}checked{% endif %} />
                        {{ 'VisitorExclusion_MatchAll'|translate }}
                    </label>
                    <label>
                        <input type="radio" name="match_all" value="0"
                               {% if editRule and not editRule.match_all %}checked{% endif %} />
                        {{ 'VisitorExclusion_MatchAny'|translate }}
                    </label>
                </div>
            </div>

            {# Conditions ─────────────────────────────────────── #}
            <div class="ve-field-group">
                <label>{{ 'VisitorExclusion_Conditions'|translate }} *</label>

                <div id="ve-condition-rows">
                    {% set conditionList = editRule and editRule.conditions_decoded is not empty ? editRule.conditions_decoded : [{}] %}
                    {% for cond in conditionList %}
                    <div class="ve-condition-group">
                        <div class="ve-condition-row">
                            <select name="condition_field[]" class="browser-default ve-field-select">
                                {% for fieldId, fieldLabel in availableFields %}
                                <option value="{{ fieldId }}"
                                        {% if cond.field is defined and cond.field == fieldId %}selected{% endif %}>{{ fieldLabel }}</option>
                                {% endfor %}
                            </select>
                            <select name="condition_operator[]" class="browser-default ve-op-select">
                                {% for opId, opLabel in availableOperators %}
                                <option value="{{ opId }}"
                                        {% if cond.operator is defined and cond.operator == opId %}selected{% endif %}>{{ opLabel }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" name="condition_value[]"
                                   class="browser-default ve-value-input"
                                   value="{{ cond.value is defined ? cond.value|e : '' }}"
                                   placeholder="{{ 'VisitorExclusion_Value'|translate }}" />
                            <button type="button" class="ve-remove-btn" title="{{ 'General_Remove'|translate }}">
                                <span class="icon-minus"></span>
                            </button>
                        </div>
                        <div class="ve-row-hint"></div>
                    </div>
                    {% endfor %}
                </div>

                <a href="#" id="ve-add-condition" style="font-size: 13px; margin-top: 6px; display: inline-block;">
                    <span class="icon-add" style="font-size: 11px;"></span>
                    {{ 'VisitorExclusion_AddCondition'|translate }}
                </a>
            </div>

            {# Submit buttons ─────────────────────────────────── #}
            <div style="margin-top: 8px;">
                <input type="submit" class="btn" value="{{ 'VisitorExclusion_SaveRule'|translate }}" />
                {% if editRule %}
                    <a href="?module=VisitorExclusion&action=index"
                       class="btn-flat" style="margin-left: 12px;">{{ 'General_Cancel'|translate }}</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

</div>{# .visitorExclusion-wrap #}

{# ══════════════════════════════════════════════════════════════
   Native Matomo confirm dialog (delete)
════════════════════════════════════════════════════════════════ #}
<div class="ui-confirm" id="ve-confirm-delete">
    <h2>{{ 'VisitorExclusion_ConfirmDeleteTitle'|translate }}</h2>
    <p>{{ 'VisitorExclusion_ConfirmDelete'|translate }}</p>
    <input role="yes" type="button" value="{{ 'General_Yes'|translate }}" />
    <input role="no"  type="button" value="{{ 'General_No'|translate }}" />
</div>

{# ══════════════════════════════════════════════════════════════
   Datalists (browser autocomplete for known value sets)
════════════════════════════════════════════════════════════════ #}
<datalist id="ve-dl-screenResolution">
    <option value="1920x1080">1920x1080 — Full HD desktop</option>
    <option value="2560x1440">2560x1440 — 2K / QHD desktop</option>
    <option value="3840x2160">3840x2160 — 4K desktop</option>
    <option value="1366x768">1366x768 — laptop</option>
    <option value="1280x800">1280x800 — laptop</option>
    <option value="1440x900">1440x900 — laptop</option>
    <option value="375x812">375x812 — iPhone X / 11</option>
    <option value="390x844">390x844 — iPhone 12 / 13 / 14</option>
    <option value="414x896">414x896 — iPhone XR / 11</option>
    <option value="360x800">360x800 — Android phone</option>
    <option value="768x1024">768x1024 — iPad portrait</option>
    <option value="1024x768">1024x768 — iPad landscape</option>
</datalist>

<datalist id="ve-dl-deviceType">
    <option value="smartphone">smartphone — mobile phone</option>
    <option value="tablet">tablet — iPad, Android tablet</option>
    <option value="desktop">desktop — regular computer</option>
    <option value="bot">bot — search engine crawlers, scrapers</option>
    <option value="tv">tv — smart TV</option>
    <option value="console">console — game console</option>
    <option value="car browser">car browser</option>
    <option value="smart display">smart display</option>
    <option value="smart speaker">smart speaker</option>
    <option value="wearable">wearable — smartwatch</option>
    <option value="peripheral">peripheral — printer, camera</option>
    <option value="phablet">phablet — large phone</option>
</datalist>

<datalist id="ve-dl-browserName">
    <option value="Chrome">Chrome</option>
    <option value="Firefox">Firefox</option>
    <option value="Safari">Safari</option>
    <option value="Edge">Edge</option>
    <option value="Internet Explorer">Internet Explorer</option>
    <option value="Opera">Opera</option>
    <option value="Samsung Browser">Samsung Browser</option>
    <option value="Yandex Browser">Yandex Browser</option>
    <option value="UC Browser">UC Browser</option>
    <option value="Brave">Brave</option>
    <option value="Vivaldi">Vivaldi</option>
</datalist>

<datalist id="ve-dl-operatingSystem">
    <option value="Windows">Windows</option>
    <option value="macOS">macOS</option>
    <option value="Linux">Linux</option>
    <option value="Ubuntu">Ubuntu</option>
    <option value="Debian">Debian</option>
    <option value="iOS">iOS</option>
    <option value="Android">Android</option>
    <option value="Chrome OS">Chrome OS</option>
    <option value="Windows Phone">Windows Phone</option>
    <option value="FreeBSD">FreeBSD</option>
</datalist>

<datalist id="ve-dl-browserLanguage">
    <option value="ar">ar — Arabic</option>
    <option value="de">de — German</option>
    <option value="en">en — English</option>
    <option value="es">es — Spanish</option>
    <option value="fr">fr — French</option>
    <option value="it">it — Italian</option>
    <option value="ja">ja — Japanese</option>
    <option value="ko">ko — Korean</option>
    <option value="nl">nl — Dutch</option>
    <option value="pl">pl — Polish</option>
    <option value="pt">pt — Portuguese</option>
    <option value="ru">ru — Russian</option>
    <option value="tr">tr — Turkish</option>
    <option value="uk">uk — Ukrainian</option>
    <option value="vi">vi — Vietnamese</option>
    <option value="zh">zh — Chinese</option>
</datalist>

{# ── Hidden template row (cloned when adding a condition) ──── #}
<div id="ve-row-template" style="display: none;" aria-hidden="true">
    <div class="ve-condition-group">
        <div class="ve-condition-row">
            <select name="condition_field[]" class="browser-default ve-field-select">
                {% for fieldId, fieldLabel in availableFields %}
                <option value="{{ fieldId }}">{{ fieldLabel }}</option>
                {% endfor %}
            </select>
            <select name="condition_operator[]" class="browser-default ve-op-select">
                {% for opId, opLabel in availableOperators %}
                <option value="{{ opId }}">{{ opLabel }}</option>
                {% endfor %}
            </select>
            <input type="text" name="condition_value[]" class="browser-default ve-value-input"
                   placeholder="{{ 'VisitorExclusion_Value'|translate }}" />
            <button type="button" class="ve-remove-btn" title="{{ 'General_Remove'|translate }}">
                <span class="icon-minus"></span>
            </button>
        </div>
        <div class="ve-row-hint"></div>
    </div>
</div>

<script>
(function ($) {

    /* ── Per-field metadata ───────────────────────────────────── */
    var examplesLabel = '{{ "VisitorExclusion_ExamplesLabel"|translate|e("js") }}';

    var fieldMeta = {
        'ip': {
            placeholder: '192.168.1.0/24',
            hint: '{{ "VisitorExclusion_HintIp"|translate|e("js") }}',
            examples: ['192.168.1.42', '10.0.0.0/8', '172.16.0.0/12', '::1'],
            opsGroup: 'ip'
        },
        'userAgent': {
            placeholder: 'Googlebot',
            hint: '{{ "VisitorExclusion_HintUserAgent"|translate|e("js") }}',
            examples: [
                'Googlebot', 'bingbot', 'YandexBot', 'Baiduspider',
                'AhrefsBot', 'SemrushBot', 'DotBot', 'MJ12bot',
                'PetalBot', 'DataForSeoBot', 'Amazonbot',
                'facebookexternalhit', 'Twitterbot',
                'python-requests', 'curl/', 'Go-http-client'
            ],
            opsGroup: 'string'
        },
        'pageUrl': {
            placeholder: '/admin/',
            hint: '{{ "VisitorExclusion_HintPageUrl"|translate|e("js") }}',
            examples: ['/wp-admin/', '/phpmyadmin/', '?utm_source=spam', 'https://internal.example.com'],
            opsGroup: 'string'
        },
        'referrerUrl': {
            placeholder: 'spam-site.com',
            hint: '{{ "VisitorExclusion_HintReferrerUrl"|translate|e("js") }}',
            examples: ['semalt.com', 'buttons-for-website.com', 'social-buttons.com'],
            opsGroup: 'string'
        },
        'deviceType': {
            placeholder: 'bot',
            hint: '{{ "VisitorExclusion_HintDeviceType"|translate|e("js") }}',
            examples: ['bot', 'smartphone', 'tablet', 'desktop', 'tv', 'console'],
            datalist: 've-dl-deviceType',
            opsGroup: 'string'
        },
        'browserName': {
            placeholder: 'Chrome',
            hint: '{{ "VisitorExclusion_HintBrowserName"|translate|e("js") }}',
            examples: ['Chrome', 'Firefox', 'Safari', 'Edge', 'Internet Explorer'],
            datalist: 've-dl-browserName',
            opsGroup: 'string'
        },
        'operatingSystem': {
            placeholder: 'Windows',
            hint: '{{ "VisitorExclusion_HintOperatingSystem"|translate|e("js") }}',
            examples: ['Windows', 'macOS', 'Linux', 'iOS', 'Android'],
            datalist: 've-dl-operatingSystem',
            opsGroup: 'string'
        },
        'browserLanguage': {
            placeholder: 'fr',
            hint: '{{ "VisitorExclusion_HintBrowserLanguage"|translate|e("js") }}',
            examples: ['fr', 'en', 'de', 'es', 'zh', 'ru', 'ja', 'pt', 'ar'],
            datalist: 've-dl-browserLanguage',
            opsGroup: 'string'
        },
        'screenResolution': {
            placeholder: '1920x1080',
            hint: '{{ "VisitorExclusion_HintScreenResolution"|translate|e("js") }}',
            examples: ['1920x1080', '1366x768', '1280x800', '2560x1440', '375x812', '360x800'],
            datalist: 've-dl-screenResolution',
            opsGroup: 'string'
        }
    };
    for (var d = 1; d <= 20; d++) {
        fieldMeta['dimension' + d] = {
            placeholder: 'value',
            hint: '{{ "VisitorExclusion_HintCustomDimension"|translate|e("js") }}',
            examples: ['staff', 'internal', 'premium'],
            opsGroup: 'string'
        };
    }

    /* ── Operator groups ─────────────────────────────────────── */
    var opsAll = {
        'equals':            '{{ "VisitorExclusion_OpEquals"|translate|e("js") }}',
        'not_equals':        '{{ "VisitorExclusion_OpNotEquals"|translate|e("js") }}',
        'contains':          '{{ "VisitorExclusion_OpContains"|translate|e("js") }}',
        'not_contains':      '{{ "VisitorExclusion_OpNotContains"|translate|e("js") }}',
        'starts_with':       '{{ "VisitorExclusion_OpStartsWith"|translate|e("js") }}',
        'ends_with':         '{{ "VisitorExclusion_OpEndsWith"|translate|e("js") }}',
        'matches_regex':     '{{ "VisitorExclusion_OpMatchesRegex"|translate|e("js") }}',
        'not_matches_regex': '{{ "VisitorExclusion_OpNotMatchesRegex"|translate|e("js") }}',
        'in_ip_range':       '{{ "VisitorExclusion_OpInIpRange"|translate|e("js") }}',
        'not_in_ip_range':   '{{ "VisitorExclusion_OpNotInIpRange"|translate|e("js") }}'
    };
    var opsForIp     = ['equals', 'not_equals', 'in_ip_range', 'not_in_ip_range'];
    var opsForString = ['equals', 'not_equals', 'contains', 'not_contains',
                        'starts_with', 'ends_with', 'matches_regex', 'not_matches_regex'];
    var regexNote = '{{ "VisitorExclusion_HintRegexNote"|translate|e("js") }}';

    /* ── Helpers ──────────────────────────────────────────────── */
    function getMeta(field) {
        return fieldMeta[field] || { placeholder: '', hint: '', examples: [], opsGroup: 'string' };
    }

    function escHtml(s) {
        return String(s)
            .replace(/&/g,'&amp;').replace(/</g,'&lt;')
            .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function rebuildOpSelect($row) {
        var field   = $row.find('.ve-field-select').val();
        var $opSel  = $row.find('.ve-op-select');
        var current = $opSel.val();
        var allowed = getMeta(field).opsGroup === 'ip' ? opsForIp : opsForString;

        $opSel.empty();
        $.each(allowed, function (i, opId) {
            $opSel.append($('<option>').val(opId).text(opsAll[opId]));
        });
        if (allowed.indexOf(current) !== -1) { $opSel.val(current); }
    }

    function updateValueInput($row) {
        var meta   = getMeta($row.find('.ve-field-select').val());
        var $input = $row.find('.ve-value-input');
        if ($input.val() === '') {
            $input.attr('placeholder', meta.examples[0] || meta.placeholder || '');
        }
        meta.datalist ? $input.attr('list', meta.datalist) : $input.removeAttr('list');
    }

    function updateRowHint($group) {
        var $row     = $group.find('.ve-condition-row');
        var $hint    = $group.find('.ve-row-hint');
        var field    = $row.find('.ve-field-select').val();
        var operator = $row.find('.ve-op-select').val();
        var meta     = getMeta(field);
        var lines    = [];

        if (meta.hint) { lines.push(meta.hint); }

        if (meta.examples && meta.examples.length) {
            lines.push(examplesLabel + ' <span class="ve-examples">'
                + meta.examples.map(escHtml).join(', ') + '</span>');
        }

        if (operator === 'matches_regex' || operator === 'not_matches_regex') {
            lines.push(regexNote + (meta.examples.length
                ? ' &mdash; <span class="ve-examples">'
                  + escHtml(meta.examples.slice(0, 4).join('|')) + '</span>'
                : ''));
        }

        lines.length ? $hint.html(lines.join('<br>')).show() : $hint.hide();
    }

    function initRow($group) {
        var $row = $group.find('.ve-condition-row');
        rebuildOpSelect($row);
        updateValueInput($row);
        updateRowHint($group);
    }

    /* ── Add condition ────────────────────────────────────────── */
    $('#ve-add-condition').on('click', function (e) {
        e.preventDefault();
        var $tmpl = $('#ve-row-template .ve-condition-group').clone(true);
        $tmpl.find('.ve-value-input').val('');
        $('#ve-condition-rows').append($tmpl);
        initRow($tmpl);
        $tmpl.find('.ve-field-select').trigger('focus');
    });

    /* ── Remove condition ─────────────────────────────────────── */
    $(document).on('click', '.ve-remove-btn', function () {
        if ($('#ve-condition-rows .ve-condition-group').length > 1) {
            $(this).closest('.ve-condition-group').remove();
        }
    });

    /* ── Field / operator change ──────────────────────────────── */
    $(document).on('change', '.ve-field-select', function () {
        var $group = $(this).closest('.ve-condition-group');
        rebuildOpSelect($group.find('.ve-condition-row'));
        updateValueInput($group.find('.ve-condition-row'));
        updateRowHint($group);
    });
    $(document).on('change', '.ve-op-select', function () {
        updateRowHint($(this).closest('.ve-condition-group'));
    });

    /* ── Toggle switch ────────────────────────────────────────── */
    $(document).on('change', '.ve-toggle-cb', function () {
        var $cb      = $(this);
        var ruleId   = $cb.data('rule-id');
        var enabled  = $cb.is(':checked') ? 1 : 0;
        var $form    = $('#ve-toggle-form-' + ruleId);
        $form.find('.ve-enabled-input').val(enabled);
        $form.submit();
    });

    /* ── Delete via ui-confirm ────────────────────────────────── */
    var pendingDeleteId = null;

    $(document).on('click', '.ve-action-delete', function (e) {
        e.preventDefault();
        pendingDeleteId = $(this).data('rule-id');
        piwikHelper.modalConfirm('#ve-confirm-delete', {
            yes: function () {
                if (pendingDeleteId !== null) {
                    $('#ve-delete-form-' + pendingDeleteId).submit();
                }
            }
        });
    });

    /* ── Initialise all existing condition rows ───────────────── */
    $('#ve-condition-rows .ve-condition-group').each(function () {
        initRow($(this));
    });

}(jQuery));
</script>

{% endblock %}
